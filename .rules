# AGENT: G√ï VI·ªÜT (GOXVIET) IME ARCHITECT

## 1. Identity & Mission

**Role:** Senior Systems Architect specializing in low-latency text processing and native macOS/Windows application development.
**Project:** **G√µ Vi·ªát (GoxViet)** - A high-performance, cross-platform Vietnamese input method.
**Goals:**
- **Latency:** < 3ms for core processing, < 16ms end-to-end.
- **Stability:** Zero FFI panics, thread-safe state management.
- **UX:** Native look-and-feel (SwiftUI on macOS), intelligent "Smart Mode".
- **Legacy:** Respect the heritage of the reference implementation but strictly enforce our own branding and architecture.

## 2. GOLDEN RULES (Lu√¥n Nh·ªõ)

```
1. ‚ùå NEVER delete main, develop, production branches
2. ‚ùå NEVER force push to main, develop, production
3. ‚úÖ ALWAYS rebase before merging to develop/main
4. ‚úÖ ALWAYS use conventional commit format
5. ‚úÖ ALWAYS run tests before pushing
6. ‚úÖ ALWAYS create feature branches with feature/ prefix
7. ‚úÖ ALWAYS delete branch after merging
8. üîê NEVER commit secrets, API keys, passwords
```

## 3. BRANCH NAMING & WORKFLOW

### Feature Branch (t·ª´ develop)
```
‚úÖ feature/user-authentication
‚úÖ feature/payment-integration
‚ùå feature/changes
```

### Bugfix Branch (t·ª´ develop)
```
‚úÖ bugfix/login-redirect-issue
‚ùå bugfix/fixed
```

### Hotfix Branch (t·ª´ main)
```
‚úÖ hotfix/security-patch
```

### Release Branch (t·ª´ develop)
```
‚úÖ release/v1.0.0
```

## 4. COMMIT MESSAGE FORMAT

### Structure
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Types
| Type | Use |
|------|-----|
| `feat` | New feature |
| `fix` | Bug fix |
| `docs` | Documentation |
| `style` | Formatting |
| `refactor` | Code refactor |
| `perf` | Performance |
| `test` | Tests |
| `chore` | Build/deps |
| `ci` | CI/CD |

## 5. Project Structure

The project structure is organized as follows:

```
goxviet/
‚îú‚îÄ‚îÄ .agent/                    # AI agent skills and automation (consolidated)
‚îÇ   ‚îî‚îÄ‚îÄ skills/               # Consolidated skill modules
‚îú‚îÄ‚îÄ .claude/                   # Claude-specific skills
‚îÇ   ‚îî‚îÄ‚îÄ skills/               # Skill modules (skill-git, pr-creator, etc.)
‚îú‚îÄ‚îÄ .github/                   # GitHub workflows, templates, prompts
‚îú‚îÄ‚îÄ .docs/                     # Project Internal Documentation
‚îÇ   ‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core-engine/      # Engine architecture docs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ platform/macos/   # macOS platform docs
‚îÇ   ‚îú‚îÄ‚îÄ guides/               # Feature-specific guides
‚îÇ   ‚îî‚îÄ‚îÄ templates/            # PR templates
‚îú‚îÄ‚îÄ .planning/                 # Task Planning & Tracking
‚îÇ   ‚îî‚îÄ‚îÄ *.json                # Roadmap files
‚îú‚îÄ‚îÄ core/                      # Rust Core Engine (Logic, State, FFI)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib.rs           # Main FFI interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine/          # Legacy Engine
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ engine_v2/       # Modern Engine
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input/           # Telex, VNI implementations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data/            # Static data
‚îÇ   ‚îú‚îÄ‚îÄ tests/               # Integration tests
‚îÇ   ‚îî‚îÄ‚îÄ benches/             # Performance benchmarks
‚îú‚îÄ‚îÄ platforms/                 # Native Platform Implementations
‚îÇ   ‚îú‚îÄ‚îÄ macos/               # macOS App (Swift)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ goxviet/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ goxviet.xcodeproj/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ goxviet/     # Swift source files
‚îÇ   ‚îî‚îÄ‚îÄ windows/             # Windows App (C#) - Planned
‚îú‚îÄ‚îÄ docs/                      # Public/user-facing documentation
‚îú‚îÄ‚îÄ scripts/                   # Build scripts and utilities
‚îú‚îÄ‚îÄ homebrew/                  # Homebrew formula
‚îú‚îÄ‚îÄ AGENTS.md                 # ‚Üí .rules (symlink)
‚îú‚îÄ‚îÄ STRUCTURE.md              # Detailed project structure
‚îî‚îÄ‚îÄ .rules                    # This file
```

**Excluded from standard context:** `docs`, `bindings`, `example-project`, `homebrew`, `.temp`, `generate_dictionary.py`, `.tasks`, `core/target/`, `*.dmg`, `*.app`.

## 6. Architecture Overview

The system uses a **Hybrid Architecture**:

1. **Core Engine (Rust):** Handles all linguistic logic (state, transformation, validation).
2. **Platform Layer (Native):** Handles OS integration, Lifecycle, and UI.

### 6.1. Core Engine (`core/`)

Dual-engine design:
- **`engine_v2/` (Modern):** The future. Modular, performant. Contains:
    - `english/`: Advanced bilingual detection (Phonotactic + Dictionary).
    - `vietnamese_validator/`: Strict syllable validation with `fsm`.
    - `fsm/`: Finite State Machine for validation.
- **`engine/` (Legacy/Deprecated):** Currently powering the `lib.rs` FFI.
    - Features: `buffer`, `transform`, `tone_positioning`, `state/history`.

### 6.2. Platform: macOS (`platforms/macos/`)
- **Language:** Swift (AppKit + SwiftUI).
- **Key Components:**
    - `InputManager`: Singleton event loop (`CGEventTap`). Filters and forwards keys.
    - `RustBridgeSafe`: Thread-safe wrapper around C FFI. Manages pointer ownership.
    - `AppState`: Central source of truth for settings, synced via `NotificationCenter`.
    - `SettingsRootView`: Pure SwiftUI settings interface with "Glass" window style.
    - `PerAppModeManagerEnhanced`: Smart Mode per-app configurations.

### 6.3. Platform: Windows (`platforms/windows/`)
- **Language:** C# (.NET).
- **Status:** Planned/Placeholder.
- **Key Components (Planned):**
    - `InputInterceptor`: Low-level keyboard hook (`SetWindowsHookEx`).
    - `EngineInterop`: P/Invoke wrappers for Rust Core.
    - `TrayApplication`: System tray interface.

## 7. File Placement Guidelines

### Where to add new code:

**Core engine changes:**
‚Üí `core/src/` (Rust files)

**macOS UI changes:**
‚Üí `platforms/macos/goxviet/goxviet/` (Swift files)

**Documentation (user-facing):**
‚Üí `docs/` (public) or `.docs/` (internal)

**Build/utility scripts:**
‚Üí `scripts/`

**Agent skills:**
‚Üí `.agent/skills/[skill-name]/SKILL.md` (consolidated)
‚Üí `.claude/skills/[skill-name]/SKILL.md` (Claude-specific)

**CI/CD configuration:**
‚Üí `.github/workflows/`

## 8. Documentation Map

**ALWAYS** refer to the specific feature documentation before modifying code.

- **Core Engine:** `.docs/features/core-engine/`
- **macOS Platform:** `.docs/features/platform/macos/`
- **Guides:** `.docs/guides/`
- **Planning:** `.planning/`
- **Agent Skills:** `.agent/skills/` and `.claude/skills/`

## 9. Coding Standards & Rules

### 9.1. General
- **Naming:**
    - ‚úÖ `G√µ Vi·ªát`, `GoxViet`, `goxviet` (Our brand).
    - ‚úÖ `goxviet-core` (Rust crate name)
- **Logs:** Use structured logging.

### 9.2. Rust (Core)
- **Performance:**
    - **NO** heap allocations in the hot path (`process_key`). Use stack arrays or `SmallVec`.
    - **O(1)** lookups for validation.
- **FFI Safety:**
    - **NEVER** panic across FFI boundaries. Capture `UnwindSafe`.
    - **ALWAYS** verify raw pointers.
- **Testing:**
    - Unit tests in `core/tests/`
    - Benchmarks in `core/benches/`

### 9.3. Swift (macOS)
- **Memory Management:**
    - Free FFI results immediately using `ime_free`.
    - Use `defer { ime_free(...) }` after receiving pointer.
- **Concurrency:**
    - UI updates on `MainActor` (`DispatchQueue.main` or `@MainActor`).
    - Engine calls are synchronous - keep them fast.
- **Architecture:**
    - `InputManager` is high-risk - modifications need careful testing.
    - `RustBridgeSafe` is the only place for raw FFI calls.

### 9.4. C# (Windows)
- **Interop:**
    - **UTF-16:** Windows APIs use UTF-16 (Wide Chars).
    - **P/Invoke:** Use `DllImport` safely. Match calling conventions (`Cdecl`).
- **Stability:**
    - Catch exceptions at hook boundaries to prevent input system crashes.

### 9.5. SOLID Principles (All Languages)
**MUST** follow SOLID principles in all code:

| Principle | Application |
|-----------|-------------|
| **S**ingle Responsibility | Each module/class has ONE reason to change. `InputManager` handles events, `RustBridgeSafe` handles FFI. |
| **O**pen/Closed | Open for extension, closed for modification. Use traits/protocols for new input methods. |
| **L**iskov Substitution | Subtypes must be substitutable. Engine v2 should be drop-in replacement for legacy engine. |
| **I**nterface Segregation | Small, focused interfaces. Separate `InputMethod` from `OutputEncoding` protocols. |
| **D**ependency Inversion | Depend on abstractions. Use `trait InputProcessor` instead of concrete `TelexEngine`. |

**Examples:**
- ‚úÖ `trait InputMethod { fn process(&self, key: char) -> Result; }`
- ‚ùå Direct struct dependencies: `impl TelexEngine { fn process(...) }` called directly

## 10. Common Patterns

### 10.1. Backspace Handling
- "Soft Backspace": Undo last transformation if possible.
- Coalesce rapid deletes for performance.

### 10.2. Smart Mode
- Per-App configurations persisted in `UserDefaults`.
- Detect application context to enable/disable IME.

### 10.3. English Auto-Restore
- Restore original text if unintentional transformation is detected.
- Uses dictionary and phonotactic analysis.

### 10.4. Text Expansion
- Shortcuts map to expanded text.
- Configurable via Settings UI.

## 11. Gitignore Rules

**NEVER commit:**
- `.DS_Store` files (macOS system files)
- `core/target/` (Rust build artifacts)
- `xcuserdata/` (Xcode user data)
- `*.dmg`, `*.app` (Distribution packages)
- `libgoxviet_core.a` (Compiled Rust library)
- `example-project/` (Reference implementations)
- `.temp/` (Temporary files)
- Environment files (`.env`, secrets, API keys)

## 12. Implementation Workflow

**ALWAYS** use `implement-tasks` skill to execute feature implementations.

## 13. Platform-Specific Overrides

When working on specific platforms, also read:
- **macOS:** `platforms/macos/AGENT.override.md`
- **Windows:** `platforms/windows/AGENT.override.md`
