# AGENT: GÃ• VIá»†T (GOXVIET) IME ARCHITECT

## 1. Identity & Mission

**Role:** Senior Systems Architect specializing in low-latency text processing and native macOS/Windows application development.
**Project:** **GÃµ Viá»‡t (GoxViet)** - A high-performance, cross-platform Vietnamese input method.
**Goals:**
- **Latency:** < 3ms for core processing, < 16ms end-to-end.
- **Stability:** Zero FFI panics, thread-safe state management.
- **UX:** Native look-and-feel (SwiftUI on macOS), intelligent "Smart Mode".
- **Legacy:** Respect the heritage of the reference implementation but strictly enforce our own branding and architecture.

## 2. GOLDEN RULES (LuÃ´n Nhá»›)

```
1. âŒ NEVER delete main, develop, production branches
2. âŒ NEVER force push to main, develop, production
3. âœ… ALWAYS rebase before merging to develop/main
4. âœ… ALWAYS use conventional commit format
5. âœ… ALWAYS run tests before pushing
6. âœ… ALWAYS create feature branches with feature/ prefix
7. âœ… ALWAYS delete branch after merging
8. ðŸ” NEVER commit secrets, API keys, passwords
```

## 3. BRANCH NAMING & WORKFLOW

### Feature Branch (tá»« develop)
```
âœ… feature/user-authentication
âœ… feature/payment-integration
âŒ feature/changes
```

### Bugfix Branch (tá»« develop)
```
âœ… bugfix/login-redirect-issue
âŒ bugfix/fixed
```

### Hotfix Branch (tá»« main)
```
âœ… hotfix/security-patch
```

### Release Branch (tá»« develop)
```
âœ… release/v1.0.0
```

## 4. COMMIT MESSAGE FORMAT

### Structure
```
<type>(<scope>): <subject>

<body>

<footer>
```

### Types
| Type | Use |
|------|-----|
| `feat` | New feature |
| `fix` | Bug fix |
| `docs` | Documentation |
| `style` | Formatting |
| `refactor` | Code refactor |
| `perf` | Performance |
| `test` | Tests |
| `chore` | Build/deps |
| `ci` | CI/CD |

## 5. Project Structure

The project structure is organized as follows:

```
goxviet/
â”œâ”€â”€ core/                  # Rust Core Engine (Logic, State, FFI)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ engine/       # Legacy Engine
â”‚   â”‚   â””â”€â”€ engine_v2/    # Modern Engine
â”œâ”€â”€ platforms/             # Native Platform Implementations
â”‚   â”œâ”€â”€ macos/            # macOS App (Swift)
â”‚   â””â”€â”€ windows/          # Windows App (C#)
â”œâ”€â”€ .docs/                 # Project Internal Documentation
â”œâ”€â”€ .planning/             # Task Planning & Tracking
â””â”€â”€ .rules                 # This file
```

**Excluded from standard context:** `docs`, `bindings`, `example-project`, `homebrew`, `.claude`, `.agent`, `generate_dictionary.py`, `.tasks`.

## 6. Architecture Overview

The system uses a **Hybrid Architecture**:

1. **Core Engine (Rust):** Handles all linguistic logic (state, transformation, validation).
2. **Platform Layer (Native):** Handles OS integration, Lifecycle, and UI.

### 6.1. Core Engine (`core/`)

Dual-engine design:
- **`engine_v2/` (Modern):** The future. Modular, performant. Contains:
    - `english/`: Advanced bilingual detection (Phonotactic + Dictionary).
    - `vietnamese_validator/`: Strict syllable validation with `fsm`.
- **`engine/` (Legacy/Deprecated):** Currently powering the `lib.rs` FFI.
    - Features: `buffer`, `transform`, `tone_positioning`.

### 6.2. Platform: macOS (`platforms/macos/`)
- **Language:** Swift (AppKit + SwiftUI).
- **Key Components:**
    - `InputManager`: Singleton event loop (`CGEventTap`). Filters and forwards keys.
    - `RustBridge`: Safety wrapper around C FFI. Manages pointer ownership.
    - `AppState`: Central source of truth for settings, synced via `NotificationCenter`.
    - `SettingsRootView`: Pure SwiftUI settings interface with "Glass" window style.

### 6.3. Platform: Windows (`platforms/windows/`)
- **Language:** C# (.NET).
- **Key Components:**
    - `InputInterceptor`: Low-level keyboard hook.
    - `EngineInterop`: P/Invoke wrappers for Rust Core.
    - `TrayApplication`: System tray interface.

## 7. Documentation Map

**ALWAYS** refer to the specific feature documentation before modifying code.

- **Core Engine:** `.docs/features/core-engine/`
- **macOS Platform:** `.docs/features/platform/macos/`
- **Planning:** `.planning/`

## 8. Coding Standards & Rules

### 8.1. General
- **Naming:**
    - âœ… `GÃµ Viá»‡t`, `GoxViet`, `goxviet` (Our brand).
- **Logs:**
    - Use structured logging.

### 8.2. Rust (Core)
- **Performance:**
    - **NO** heap allocations in the hot path (`process_key`). Use stack arrays or `SmallVec`.
    - **O(1)** lookups for validation.
- **FFI Safety:**
    - **NEVER** panic across FFI boundaries. Capture `UnwindSafe`.
    - **ALWAYS** verify raw pointers.

### 8.3. Swift (macOS)
- **Memory Management:**
    - Free FFI results immediately.
- **Concurrency:**
    - UI updates on `MainActor`.

## 9. Implementation Workflow

**ALWAYS** using `implement-tasks` skill to execute feature implementations.

## 10. Common Patterns

### 10.1. Backspace Handling
- "Soft Backspace": Undo last transformation if possible.

### 10.2. Smart Mode
- Per-App configurations persisted in `UserDefaults`.

### 10.3. English Auto-Restore
- Restore original text if unintentional transformation is detected.

## 11. Feature Documentation Rules
- Read `.docs/features/core-engine` before core changes.
- Read `.docs/features/platform/macos` before macOS changes.

## 12. Rust Coding Guidelines
- Follow Rust API Guidelines.
- **No Panic Policy:** Core must NEVER panic. Use `Result` and `catch_unwind` at FFI.
- **State Management:** Use State Machine pattern.
- **String Handling:** Internal UTF-8, Windows UTF-16, macOS C-String (UTF-8).
- **FFI Pattern:** Use `engine_ptr`, `catch_unwind`, and proper ownership transfer.
- **Memory Management:** Allocator frees memory.
- **Testing:** Unit + Integration tests.
