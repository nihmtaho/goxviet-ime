# G√µ Vi·ªát (GoxViet) - Automated Release Workflow
# Created: 2025-12-21
# Updated: 2025-01-xx
# Purpose: Automate tag creation, GitHub release, and DMG upload
#
# Workflow:
# 1. Trigger on tag push (v*.*.*)
# 2. Checkout code from main branch
# 3. Build Rust core library (universal binary for arm64 + x86_64)
# 4. Build macOS app with Xcode
# 5. Create unsigned DMG for Homebrew distribution
# 6. Read release notes from docs/release-note/RELEASE_NOTE_${VERSION}.md
# 7. Create GitHub Release with DMG attachment

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write

env:
  APP_NAME: GoxViet
  BUNDLE_ID: com.goxviet.ime
  RUST_BACKTRACE: 1

jobs:
  check-release:
    name: Check Release Exists
    runs-on: ubuntu-latest
    outputs:
      release_exists: ${{ steps.check_release.outputs.release_exists }}
    steps:
      - name: Extract tag
        id: extract
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check if GitHub release exists for tag
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.extract.outputs.tag }}
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          echo "Checking release: $API_URL"
          http_status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${GITHUB_TOKEN}" "$API_URL" ) || true
          if [ "$http_status" = "200" ]; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
            echo "Found existing release for $TAG"
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
            echo "No release found for $TAG (http_status=$http_status)"
          fi

  build-macos:
    name: Build macOS Release
    needs: check-release
    if: needs.check-release.outputs.release_exists != 'true'
    runs-on: macos-15-intel

    steps:
      # ============================================
      # SETUP
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Always build from main branch
          fetch-depth: 0
          fetch-tags: true

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"

      # (release existence already checked in `check-release` job)

      # ============================================
      # RUST BUILD
      # ============================================
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Build Rust core library (Universal Binary)
        run: |
          cd core

          # Build for Apple Silicon (arm64)
          echo "üî® Building for aarch64-apple-darwin..."
          cargo build --release --target aarch64-apple-darwin

          # Build for Intel (x86_64)
          echo "üî® Building for x86_64-apple-darwin..."
          cargo build --release --target x86_64-apple-darwin

          # Create universal binary using lipo
          echo "üîó Creating universal binary..."
          lipo -create \
            target/aarch64-apple-darwin/release/libgoxviet_core.a \
            target/x86_64-apple-darwin/release/libgoxviet_core.a \
            -output ../platforms/macos/goxviet/libgoxviet_core.a

          echo "‚úÖ Rust core built successfully (Universal Binary)"
          ls -lh ../platforms/macos/goxviet/libgoxviet_core.a

      # ============================================
      # XCODE BUILD
      # ============================================
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'  # Use available Xcode version on hosted runner

      - name: Clean Xcode DerivedData
        run: |
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          echo "üßπ Cleaned DerivedData cache"

      - name: Build macOS app
        run: |
          cd platforms/macos/goxviet

          # Build for Release configuration (unsigned for community distribution)
          xcodebuild \
            -project goxviet.xcodeproj \
            -scheme goxviet \
            -configuration Release \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build

          echo "‚úÖ macOS app built successfully"

          # Verify app exists
          APP_PATH="./build/Build/Products/Release/${{ env.APP_NAME }}.app"
          if [ -d "$APP_PATH" ]; then
            echo "üì± App location: $APP_PATH"
            ls -la "$APP_PATH"
          else
            echo "‚ùå App not found at expected location"
            find ./build -name "*.app" -type d
            exit 1
          fi

      # ============================================
      # DMG CREATION
      # ============================================
      - name: Create unsigned DMG for Homebrew
        id: create_dmg
        run: |
          VERSION=${{ steps.version.outputs.version }}
          APP_PATH="platforms/macos/goxviet/build/Build/Products/Release/${{ env.APP_NAME }}.app"
          DMG_NAME="${{ env.APP_NAME }}-${VERSION}-unsigned.dmg"
          DMG_DIR="dist"
          DMG_PATH="${DMG_DIR}/${DMG_NAME}"

          # Create dist directory
          mkdir -p "$DMG_DIR"

          # Create staging directory
          STAGING_DIR=$(mktemp -d)
          echo "üìÅ Staging directory: $STAGING_DIR"

          # Copy app to staging
          cp -R "$APP_PATH" "$STAGING_DIR/"

          # Create Applications symlink
          ln -s /Applications "$STAGING_DIR/Applications"

          # Update version in Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$STAGING_DIR/${{ env.APP_NAME }}.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "$STAGING_DIR/${{ env.APP_NAME }}.app/Contents/Info.plist"
          echo "üìù Updated Info.plist with version $VERSION"

          # Calculate size needed (app size + 50MB buffer)
          APP_SIZE=$(du -sm "$APP_PATH" | cut -f1)
          DMG_SIZE=$((APP_SIZE + 50))
          echo "üíæ DMG size: ${DMG_SIZE}MB"

          # Create temporary DMG
          TEMP_DMG="${DMG_DIR}/temp.dmg"
          hdiutil create -srcfolder "$STAGING_DIR" \
            -volname "${{ env.APP_NAME }}" \
            -fs HFS+ \
            -fsargs "-c c=64,a=16,e=16" \
            -format UDRW \
            -size ${DMG_SIZE}m \
            "$TEMP_DMG"

          # Convert to compressed DMG
          hdiutil convert "$TEMP_DMG" \
            -format UDZO \
            -imagekey zlib-level=9 \
            -o "$DMG_PATH"

          # Clean up
          rm -f "$TEMP_DMG"
          rm -rf "$STAGING_DIR"

          # Verify DMG
          if [ -f "$DMG_PATH" ]; then
            echo "‚úÖ DMG created successfully: $DMG_PATH"
            ls -lh "$DMG_PATH"
            echo "dmg_file=$DMG_PATH" >> $GITHUB_OUTPUT
            echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ùå DMG creation failed"
            exit 1
          fi

      # ============================================
      # RELEASE NOTES
      # ============================================
      - name: Prepare release notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          NOTE_FILE="docs/release-note/RELEASE_NOTE_${VERSION}.md"

          echo "üìÑ Looking for release note: $NOTE_FILE"

          if [ -f "$NOTE_FILE" ]; then
            cp "$NOTE_FILE" release_notes.md
            echo "‚úÖ Found release note for version $VERSION"
            echo "has_notes=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Release note not found, generating default..."
            echo "# G√µ Vi·ªát (GoxViet) v${VERSION}" > release_notes.md
            echo "" >> release_notes.md
            echo "## ‚ö†Ô∏è Release Note Not Found" >> release_notes.md
            echo "" >> release_notes.md
            echo "No detailed release note was provided for this version." >> release_notes.md
            echo "" >> release_notes.md
            echo "Please create \`docs/release-note/RELEASE_NOTE_${VERSION}.md\` for better release documentation." >> release_notes.md
            echo "" >> release_notes.md
            echo "---" >> release_notes.md
            echo "" >> release_notes.md
            echo "## Installation" >> release_notes.md
            echo "" >> release_notes.md
            echo "### Option 1: Download DMG" >> release_notes.md
            echo "1. Download the DMG file below" >> release_notes.md
            echo "2. Open the DMG and drag GoxViet to Applications" >> release_notes.md
            echo "3. Grant Accessibility permissions when prompted" >> release_notes.md
            echo "" >> release_notes.md
            echo "### Option 2: Homebrew (coming soon)" >> release_notes.md
            echo "\`\`\`bash" >> release_notes.md
            echo "brew install --cask goxviet" >> release_notes.md
            echo "\`\`\`" >> release_notes.md
            echo "" >> release_notes.md
            echo "---" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/...v${VERSION}" >> release_notes.md
            echo "has_notes=false" >> $GITHUB_OUTPUT
          fi

          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      # ============================================
      # GITHUB RELEASE
      # ============================================
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ env.APP_NAME }} ${{ steps.version.outputs.tag }}
          body_path: ${{ steps.release_notes.outputs.release_notes_file }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-alpha') || contains(steps.version.outputs.tag, '-beta') || contains(steps.version.outputs.tag, '-rc') }}
          files: |
            ${{ steps.create_dmg.outputs.dmg_file }}
          fail_on_unmatched_files: true

      # ============================================
      # ARTIFACTS & SUMMARY
      # ============================================
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ steps.version.outputs.version }}-macos
          path: ${{ steps.create_dmg.outputs.dmg_file }}
          retention-days: 90

      - name: Generate release summary
        run: |
          VERSION=${{ steps.version.outputs.version }}
          DMG_FILE=${{ steps.create_dmg.outputs.dmg_file }}
          DMG_NAME=${{ steps.create_dmg.outputs.dmg_name }}
          DMG_SIZE=$(ls -lh "$DMG_FILE" | awk '{print $5}')
          HAS_NOTES=${{ steps.release_notes.outputs.has_notes }}
          RELEASE_URL=${{ steps.create_release.outputs.url }}

          echo "## üéâ Release ${{ steps.version.outputs.tag }} Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.version.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release URL** | ${RELEASE_URL} |" >> $GITHUB_STEP_SUMMARY
          echo "| **DMG File** | ${DMG_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| **DMG Size** | ${DMG_SIZE} |" >> $GITHUB_STEP_SUMMARY
          if [ "$HAS_NOTES" = "true" ]; then
            echo "| **Release Notes** | ‚úÖ Custom |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Release Notes** | ‚ö†Ô∏è Auto-generated |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Assets Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- \`${DMG_NAME}\` - Unsigned DMG for Homebrew/community distribution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify the release at: ${RELEASE_URL}" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the DMG installation on a clean macOS system" >> $GITHUB_STEP_SUMMARY
          echo "3. Update Homebrew cask if applicable" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # NOTIFICATION JOB
  # ============================================
  notify:
    name: Release Notification
    runs-on: ubuntu-latest
    needs: [check-release, build-macos]
    if: always()

    steps:
      - name: Check release status
        run: |
          RELEASE_EXISTS=${{ needs.check-release.outputs.release_exists }}
          if [ "$RELEASE_EXISTS" = "true" ]; then
            echo "‚ÑπÔ∏è Release already existed for tag ${GITHUB_REF#refs/tags/}. No action taken."
            exit 0
          fi

          # If build-macos job was skipped due to an earlier exit, report accordingly
          if [ "${{ needs.build-macos.result }}" == "success" ]; then
            echo "‚úÖ Release workflow completed successfully!"
            echo "üéâ GoxViet ${{ github.ref_name }} has been released!"
          else
            echo "‚ùå Release workflow failed!"
            echo "Please check the build-macos job logs for details."
            exit 1
          fi