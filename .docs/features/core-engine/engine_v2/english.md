# English Detection (Engine V2)

The `engine_v2::english` module provides robust English language detection capabilities, essential for the "Auto Restore" feature. It distinguishes intended English words from accidental Vietnamese transformations (e.g., typing "term" vs "tờm").

## Components

### `PhonotacticEngine` (`phonotactic.rs`)

An 8-layer analysis engine that calculates a confidence score for whether a key sequence is English.

#### Detection Layers
1.  **Invalid Initials**: Detects letters that never start Vietnamese words (`F`, `J`, `W`, `Z`, `SH-`).
2.  **Onset Clusters**: Detects English-specific initial clusters (`bl`, `str`, `pl`, `gr`, etc.).
3.  **Double Consonants**: Detects doubled consonants (`ll`, `ss`, `rr`), which are rare or non-existent in Vietnamese.
4.  **Suffixes**: Identifies common English endings (`-tion`, `-ing`, `-ed`, `-ly`, `-ment`).
5.  **Coda Clusters**: Checks for valid English ending clusters (`st`, `nd`, `ct`, `mp`).
6.  **Prefixes**: Identifies English prefixes (`un-`, `re-`, `pre-`, `dis-`).
7.  **Vowel Patterns**: Detects English vowel digraphs (`ea`, `ou`).
8.  **Impossible Bigrams**: Identifies character pairs impossible in Vietnamese (`qb`, `zf`, etc.).

#### Confidence Calculation
The engine returns a `PhonotacticResult` containing:
-   `layer_scores`: Individual confidence from each layer.
-   `matched_layers`: Bitmask of which layers triggered.
-   `english_confidence`: A weighted average score (0-100%).

### `Dictionary` (`dictionary.rs`)

A highly optimized, O(1) dictionary lookup for:
-   **Common English Words**: High-frequency words (e.g., "the", "and", "that").
-   **Programming Terms**: Reserved keywords and common terms (e.g., "const", "print", "function", "array").

This module avoids heap allocations for short words by using stack arrays and static lookup tables (`PROG_TERMS_4`, `PROG_TERMS_5`, etc.).

#### Data Source
The dictionary data is generated by `generate_optimized_dictionary.py` using failure cases (`english_100k_failures.txt`) and a conflict-check against Vietnamese unigrams. Specific safe words like **canxi** and **cara** are manually whitelisted to ensure they are detected as English/Safe despite potential conflicts.

### `LanguageDecisionEngine` (`language_decision.rs`)

The central decision-maker that combines signals from:
1.  **Dictionary Lookup**: Highest priority (100% confidence).
2.  **Vietnamese Validation**: Penalizes English score if the input forms a valid Vietnamese syllable.
3.  **Phonotactic Analysis**: Adds to the English confidence score.
4.  **Diacritics**: Presence of explicit Vietnamese marks (ê, ư, tone marks) heavily penalizes the English score.

#### Auto-Restore Thresholds & Protection

To prevent false-positive restorations for Vietnamese words (especially those using intermediate tone placement like `phast` → `phát`), the engine applies strict confidence thresholds:

**English Confidence Required:**
-   **Valid Vietnamese Syllables** (e.g., `sao`, `khi`, `tôi`): Require a very high English confidence (**≥ 95%**) **OR** an explicit dictionary match.
    - These syllables parse correctly in Vietnamese, so we are very conservative.
    - Example: "sao" is a valid Vietnamese word; even with English patterns, we require strong signals to restore "saw".
-   **Invalid Vietnamese Syllables** (e.g., `bca`, `kx`, `fpr`): Use more aggressive thresholds (**75-95%**) depending on phonotactic strength.
    - These never form valid Vietnamese words, so English restoration is safer.
    - Example: "blur" (phonotactic `bl` cluster) at ~85% confidence triggers auto-restore.

**Intermediate Tone Placement Protection:**
- When users type a tone key (e.g., `s` for sắc) immediately after a vowel (e.g., `phast`), it forms `phás` (Vietnamese with tone).
- The engine recognizes this pattern and does NOT treat it as an English coda cluster (e.g., `st`).
- High thresholds (≥ 95%) protect these intermediate sequences from misidentification as English clusters.

**Dictionary Priority:**
- If a sequence is found in the English dictionary (common words, programming terms), it triggers immediate auto-restore regardless of syllable validity.
- Dictionary entries are pre-vetted for Vietnamese conflicts (whitelisting safe words like "canxi" and "cara").

These protections ensure that intentional Vietnamese typing (even with intermediate tone placement) is preserved, while unintended transformations of common English words are swiftly corrected.
